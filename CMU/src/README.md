# eCTF 2024 - Plaid Parliament of Pwning

This repository holds the secure design for the MISC system implemented by the Carnegie Mellon University team Plaid Parliament of Pwning.

Please see our [design doc](design_doc.pdf) which explains our system implementation, security features, and implementation details.

Following is a brief overview of the layout of this repository.

## Layout

```
.
├── application_processor - Contains code and build artifacts for the Application Processor
│   ├── Makefile - A thin wrapper around build.sh for compatibility with ectf_tools
│   ├── build.sh - Invokes common/build.sh with appropriate variables
│   ├── generate_secrets.py - Generates keys using data generated in the deployment phase
│   ├── inc
│   │   ├── ap_secure_comm.h
│   │   ├── boot_blob.h 
│   │   ├── comm_link_ap.h 
│   │   ├── encrypted.h 
│   │   ├── host_messaging.h
│   │   ├── host_uart.h
│   │   ├── keys.h
│   │   └── sec_link.h
│   └── src
│       ├── application_processor.c - Main code for the application processor, implements the functional requirements
│       ├── comm_link_ap.c - Implements link layer functions for the AP
│       ├── encrypted.c - Holds the POST_BOOT code, stored encrypted until it is ready to execute
│       ├── host_messaging.c - Implements UART wrappers to interact with host
│       ├── host_uart.c - Implements functions to access the UART peripheral
│       └── sec_link.c - Implements cryptographic wrapper over link layer 
│
├── common - Contains code and build artifacts that are common to AP and Components
│   ├── firmware.ld - Linker script for the board
│   ├── rename.ld - Linker script for renaming sections in the encrypted post boot code
│   ├── startup_firmware.S - Assembly file containing the reset vector code
│   ├── build.sh - Generic build script for compiling firmware and preparing the binary image
│   ├── inc
│   │   ├── attestation_data.h
│   │   ├── comm_link_def.h
│   │   ├── comm_link.h
│   │   ├── comm_link_phy.h
│   │   ├── comm_link_tmr.h
│   │   ├── comm_types.h
│   │   ├── crypto_wrappers.h
│   │   ├── defense_lockout.h
│   │   ├── fiproc.h
│   │   ├── hardware_init.h
│   │   ├── led.h
│   │   ├── libc_mu.h
│   │   ├── monocypher.h
│   │   ├── rng.h
│   │   ├── secure_snd_rcv.h
│   │   ├── ticks.h
│   │   └── util.h
│   ├── scripts - Python helper scripts
│   │   ├── crypto_helpers.py - Python equivalent for the crypto wrappers in C
│   │   ├── parse_header.py - Parses header files generated by ectf_tools
│   │   ├── patch_bin.py - Merge statically-generated data blobs into compiled binary
│   └── src
│       ├── comm_link.c - Logical part of link-layer
│       ├── comm_link_phy.c - Physical part of link-layer
│       ├── comm_link_tmr.c - Link layer timer handlers
│       ├── crypto_wrappers.c - Wrappers for Monocypher
│       ├── defense_lockout.c - Inserts delays when under attack
│       ├── fiproc.c - Fault injection protections
│       ├── hardware_init.c - Hardware initializations
│       ├── led.c - LED control code
│       ├── libc_mu.c - Subset of libc that we use
│       ├── monocypher.c - Cryptography library
│       ├── rng.c - Random number generator
│       ├── ticks.c - SysTick timer wrapper
│       └── util.c - Utility functions
|
├── component - Code and build artifacts for a component
│   ├── Makefile - A thin wrapper around build.sh for compatibility with ectf_tools
│   ├── generate_secrets.py - Generates keys using data generated in the deployment phase
│   ├── inc - Header files
│   │   ├── boot_blob.h
│   │   ├── comm_link_component.h
│   │   ├── component_secure_comm.h
│   │   ├── encrypted.h
│   │   ├── resources.h
│   │   └── sec_link.h
│   └── src - Source files
│       ├── comm_link_component.c - Implements link layer functions for a component
│       ├── component.c - Implements the functionality of the component
│       ├── encrypted.c - Holds the POST_BOOT code, stored encrypted until it is ready to execute
│       └── sec_link.c - Implements cryptographic wrapper over link layer
|
├── deployment - Deployment-wide 
│   ├── Makefile - This makefile is invoked by the eCTF tools when creating a deployment
│   └── global_secrets.py - Generates deployment wide secrets
|
├── ectf_tools - Host tools and build tools (provided from insecure example)
│   ├── attestation_tool.py - Runs attestation command on application processor
│   ├── boot_tool.py - Boots the application processor and sensors
│   ├── build_ap.py - Builds the AP
│   ├── build_comp.py - Builds a component
│   ├── build_depl.py - Builds deployment
│   ├── __init__.py  
│   ├── list_tool.py - Lists what sensors are currently online
│   ├── replace_tool.py - Replaces a sensor id on the application processor
│   ├── update.py - Updates the board firmware
│   └── utils.py - Utilities
└── msdk-lib - Stripped-down version of Maxim MSDK
    ├── FLC
    ├── GPIO
    ├── ICC
    ├── Include
    ├── IncludeMAX78000
    ├── PeriphDriversMAX78000
    ├── SYS
    ├── TMR
    └── UART
```


## Using the eCTF Tools

### Building the deployment 
This will run the `Makefile` found in the deployment folder using the following inputs:

```
ectf_build_depl --help
usage: eCTF Build Deployment Tool [-h] -d DESIGN

Build a deployment using Nix

options:
  -h, --help            show this help message and exit
  -d DESIGN, --design DESIGN
                        Path to the root directory of the included design
```

**Example Utilization**
```bash
ectf_build_depl -d ../ectf-2024-example
```
### Building the Application Processor
This will run the `Makefile` found in the application processor folder using the following inputs:

```
ectf_build_ap --help
usage: eCTF Build Application Processor Tool [-h] -d DESIGN -on OUTPUT_NAME [-od OUTPUT_DIR] -p P
                                             -b BOOT_MESSAGE

Build an Application Processor using Nix

options:
  -h, --help            show this help message and exit
  -d DESIGN, --design DESIGN
                        Path to the root directory of the included design
  -on OUTPUT_NAME, --output-name OUTPUT_NAME
                        Output prefix of the built application processor binary Example 'ap' -> a
  -od OUTPUT_DIR, --output-dir OUTPUT_DIR
                        Output name of the directory to store the result: default: .
  -p PIN, --pin PIN     PIN for built application processor
  -t TOKEN, --token TOKEN
                        Token for built application processor
  -c COMPONENT_CNT, --component-cnt COMPONENT_CNT
                        Number of components to provision Application Processor for
  -ids COMPONENT_IDS, --component-ids COMPONENT_IDS
                        Component IDs to provision the Application Processor for
  -b BOOT_MESSAGE, --boot-message BOOT_MESSAGE
                        Application Processor boot message
```

**Example Utilization**
```bash
ectf_build_ap -d ../ectf-2024-example -on ap --p 123456 -c 2 -ids "0x11111124, 0x11111125" -b "Test boot message" -t 0123456789abcdef -od build
```

### Building the Component
```
ectf_build_comp --help
usage: eCTF Build Application Processor Tool [-h] -d DESIGN -on OUTPUT_NAME [-od OUTPUT_DIR] -id COMPONENT_ID -b BOOT_MESSAGE -al
                                             ATTESTATION_LOCATION -ad ATTESTATION_DATE -ac ATTESTATION_CUSTOMER

Build an Application Processor using Nix

options:
  -h, --help            show this help message and exit
  -d DESIGN, --design DESIGN
                        Path to the root directory of the included design
  -on OUTPUT_NAME, --output-name OUTPUT_NAME
                        Output prefix of the built application processor binary Example 'ap' -> ap.bin, ap.elf, ap.img
  -od OUTPUT_DIR, --output-dir OUTPUT_DIR
                        Output name of the directory to store the result: default: .
  -id COMPONENT_ID, --component-id COMPONENT_ID
                        Component ID for the provisioned component
  -b BOOT_MESSAGE, --boot-message BOOT_MESSAGE
                        Component boot message
  -al ATTESTATION_LOCATION, --attestation-location ATTESTATION_LOCATION
                        Attestation data location field
  -ad ATTESTATION_DATE, --attestation-date ATTESTATION_DATE
                        Attestation data date field
  -ac ATTESTATION_CUSTOMER, --attestation-customer ATTESTATION_CUSTOMER
                        Attestation data customer field
```

**Example Utilization**
```bash
ectf_build_comp -d ../ectf-2024-example -on comp -od build -id 0x11111125 -b "Component boot" -al "McLean" -ad "08/08/08" -ac "Fritz"
```

## Flashing
Flashing the MAX78000 is done through the eCTF Bootloader. You will need to initially flash the eCTF Bootloader onto the provided hardware. 
This can be done easily by dragging and dropping the provided bootloader image to the DAPLink interface. DAPLink will show up as an external drive when connected to your system.

```
ectf_update -h
usage: ectf_update [-h] -in INFILE --port PORT [-s]

options:
  -h, --help            show this help message and exit
  -in INFILE, --infile INFILE
                        Path to the input binary
  --port PORT           Serial port
  -s, --secure          Update a secured or insecure firmware image
```

**Example Utilization**
```bash
ectf_update --infile example_fw/build/firmware.img --port /dev/ttyUSB0
```

## Host Tools
### List Tool
The list tool applies the required list components functionality from the MISC system. This is availble on the 
PATH within the Poetry environment as `ectf_list`.

```
ectf_list -h
usage: eCTF List Host Tool [-h] -a APPLICATION_PROCESSOR

List the components connected to the medical device

options:
  -h, --help            show this help message and exit
  -a APPLICATION_PROCESSOR, --application-processor APPLICATION_PROCESSOR
                        Serial device of the AP
```

**Example Utilization**
``` bash
ectf_list -a /dev/ttyUSB0
```

### Boot Tool
The boot tool boots the full system. This is available on the PATH within the Poetry environment as `ectf_boot`

```
ectf_boot --help
usage: eCTF Boot Host Tool [-h] -a APPLICATION_PROCESSOR

Boot the medical device

options:
  -h, --help            show this help message and exit
  -a APPLICATION_PROCESSOR, --application-processor APPLICATION_PROCESSOR
                        Serial device of the AP
```

**Example Utilization**
``` bash
ectf_boot -a /dev/ttyUSB0
```

### Replace Tool
The replace tool replaces a provisioned component on the system with a new component.
This is available on the PATH within the Poetry environment as `ectf_replace`.

```
ectf_replace --help
usage: eCTF Replace Host Tool [-h] -a APPLICATION_PROCESSOR -t TOKEN -i COMPONENT_IN -o COMPONENT_OUT

Replace a component on the medical device

options:
  -h, --help            show this help message and exit
  -a APPLICATION_PROCESSOR, --application-processor APPLICATION_PROCESSOR
                        Serial device of the AP
  -t TOKEN, --token TOKEN
                        Replacement token for the AP
  -i COMPONENT_IN, --component-in COMPONENT_IN
                        Component ID of the new component
  -o COMPONENT_OUT, --component-out COMPONENT_OUT
                        Component ID of the component being replaced
```

**Example Utilization**
``` bash
ectf_replace -a /dev/ttyUSB0 -t 0123456789abcdef -i 0x11111126 -o 0x11111125
```

### Attestation Tool
The attestation tool returns the confidential attestation data provisioned on a component.
This is available on the PATH within the Poetry environment as `ectf_attestation`.

``` 
ectf_attestation --help
usage: eCTF Attestation Host Tool [-h] -a APPLICATION_PROCESSOR -p PIN -c COMPONENT

Return the attestation data from a component

options:
  -h, --help            show this help message and exit
  -a APPLICATION_PROCESSOR, --application-processor APPLICATION_PROCESSOR
                        Serial device of the AP
  -p PIN, --pin PIN     PIN for the AP
  -c COMPONENT, --component COMPONENT
                        Component ID of the target component
```

**Example Utilization**
```
ectf_attestation -a /dev/ttyUSB0 -p 123456 -c 0x11111124
```
